<header class="app-header-bar">
  <div class="logo-container">
    <h1><img src="/images/LOGO-CIDAC.png" alt="logo"></h1>
  </div>

  <div class="user-badge" *ngIf="username$ | async as username">
    <mat-icon>person</mat-icon>
    <span>{{ username }}</span>
    <button mat-icon-button class="logout-btn" (click)="logout()">
      <mat-icon>logout</mat-icon>
    </button>
  </div>
</header>

<mat-sidenav-container class="layout">

  <!-- SIDEBAR -->
  <mat-sidenav #drawer [mode]="isMobile ? 'over' : 'side'" [(opened)]="opened"
    [class.collapsed]="isCollapsed && !isMobile" class="sidebar">

    <div class="sidebar-header">
      <div class="sidebar-title" *ngIf="!isCollapsed">Menu</div>
      <button mat-icon-button class="collapse-btn" (click)="toggleSidebar()">
        <mat-icon>{{ isCollapsed ? 'chevron_right' : 'chevron_left' }}</mat-icon>
      </button>
    </div>

    <mat-nav-list>
      <ng-container *ngIf="groups$ | async as groups">
        <ng-container *ngFor="let app of apps">

          <!-- App visibile per l'utente -->
          <ng-container *ngIf="canAccess(app, groups)">

            <!-- App SENZA children -->
            <ng-container *ngIf="!app.children">
              <!-- Link esterno (Django Admin) -->
              <a mat-list-item *ngIf="app.isExternal" href="#" (click)="goToDjangoAdmin($event)">
                <mat-icon>{{ app.icon }}</mat-icon>
                <span *ngIf="!isCollapsed">{{ app.label }}</span>
              </a>
              <!-- Link interno -->
              <a mat-list-item *ngIf="!app.isExternal" [routerLink]="app.path" routerLinkActive="active">
                <mat-icon>{{ app.icon }}</mat-icon>
                <span *ngIf="!isCollapsed">{{ app.label }}</span>
              </a>
            </ng-container>

            <!-- App CON children (menu espandibile) -->
            <ng-container *ngIf="app.children">
              <a mat-list-item (click)="toggleMenu(app.path)" class="menu-parent">
                <mat-icon>{{ app.icon }}</mat-icon>
                <span *ngIf="!isCollapsed">{{ app.label }}</span>
                <mat-icon *ngIf="!isCollapsed" class="expand-icon">
                  {{ isExpanded(app.path) ? 'expand_less' : 'expand_more' }}
                </mat-icon>
              </a>
              <div class="submenu" *ngIf="isExpanded(app.path) && !isCollapsed">
                <ng-container *ngFor="let child of app.children">
                  <a mat-list-item *ngIf="canAccessChildItem(app, child, groups)" [routerLink]="child.path"
                    routerLinkActive="active" [routerLinkActiveOptions]="{exact: child.path === app.path}">
                    <mat-icon>{{ child.icon }}</mat-icon>
                    <span>{{ child.label }}</span>
                  </a>
                </ng-container>
              </div>
            </ng-container>
          </ng-container>
        </ng-container>
      </ng-container>

    </mat-nav-list>

  </mat-sidenav>

  <!-- CONTENT -->
  <mat-sidenav-content class="main-content-bg">
    <div class="main-content">
      <router-outlet></router-outlet>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>