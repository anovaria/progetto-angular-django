{% extends "merchandiser/base_minimal.html" %}
{% load merch_tags %}

{% block title %}Registrazione Orari - Punto Info{% endblock %}

{% block extra_css %}
<style>
    .date-selector {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .date-selector h5 {
        margin: 0;
        text-align: center;
    }
    
    .orari-grid {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .orari-table {
        width: 100%;
        margin: 0;
    }
    
    .orari-table th {
        background: #ff5722;
        color: white;
        padding: 12px 8px;
        text-align: center;
        font-weight: 600;
    }
    
    .orari-table th:first-child {
        text-align: left;
        padding-left: 15px;
    }
    
    .orari-table td {
        padding: 8px;
        border-bottom: 1px solid #eee;
        text-align: center;
        vertical-align: middle;
    }
    
    .orari-table td:first-child {
        text-align: left;
        padding-left: 15px;
    }
    
    .orari-table input[type="time"] {
        width: 80px;
        padding: 4px;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-align: center;
        cursor: pointer;
    }
    
    .orari-table input[type="time"]:focus {
        border-color: #ff5722;
        outline: none;
    }
    
    .orari-table input[type="text"] {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .merchandiser-name {
        font-weight: 600;
    }
    
    .btn-salva-riga {
        min-width: 40px;
    }
    
    .btn-salva-riga .material-icons {
        font-size: 18px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h4 class="mb-4">
        <span class="material-icons" style="vertical-align: middle;">schedule</span>
        Registrazione Orari Merchandiser
    </h4>
    
    <!-- Data fissa: solo giorno corrente -->
    <div class="date-selector">
        <h5>
            <span class="material-icons" style="vertical-align: middle; margin-right: 10px;">today</span>
            {{ data|date:"l d F Y"|upper }}
        </h5>
    </div>
    
    <!-- Griglia orari -->
    <div class="orari-grid">
        <table class="orari-table table table-hover mb-0">
            <thead>
                <tr>
                    <th>Merchandiser</th>
                    <th>I.1</th>
                    <th>U.1</th>
                    <th>I.2</th>
                    <th>U.2</th>
                    <th>I.Extra</th>
                    <th>U.Extra</th>
                    <th>Fornitore</th>
                    <th>Note</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for item in slot_orari %}
                <tr data-slot="{{ item.slot.id }}" data-data="{{ data|date:'Y-m-d' }}">
                    <td>
                        <div class="merchandiser-name">{{ item.slot.merchandiser.nominativo }}</div>
                    </td>
                    <td>
                        <input type="time" 
                               name="ingresso_1" 
                               value="{% if item.ingresso.ingresso_1 %}{{ item.ingresso.ingresso_1|time:'H:i' }}{% endif %}"
                               ondblclick="setCurrentTime(this)">
                    </td>
                    <td>
                        <input type="time" 
                               name="uscita_1" 
                               value="{% if item.ingresso.uscita_1 %}{{ item.ingresso.uscita_1|time:'H:i' }}{% endif %}"
                               ondblclick="setCurrentTime(this)">
                    </td>
                    <td>
                        <input type="time" 
                               name="ingresso_2" 
                               value="{% if item.ingresso.ingresso_2 %}{{ item.ingresso.ingresso_2|time:'H:i' }}{% endif %}"
                               ondblclick="setCurrentTime(this)">
                    </td>
                    <td>
                        <input type="time" 
                               name="uscita_2" 
                               value="{% if item.ingresso.uscita_2 %}{{ item.ingresso.uscita_2|time:'H:i' }}{% endif %}"
                               ondblclick="setCurrentTime(this)">
                    </td>
                    <td>
                        <input type="time" 
                               name="ingresso_extra" 
                               value="{% if item.ingresso.ingresso_extra %}{{ item.ingresso.ingresso_extra|time:'H:i' }}{% endif %}"
                               ondblclick="setCurrentTime(this)">
                    </td>
                    <td>
                        <input type="time" 
                               name="uscita_extra" 
                               value="{% if item.ingresso.uscita_extra %}{{ item.ingresso.uscita_extra|time:'H:i' }}{% endif %}"
                               ondblclick="setCurrentTime(this)">
                    </td>
                    <td>
                        {% if item.slot.fornitori.all %}
                            {% with item.slot.fornitori.first.fornitore as forn %}
                                {% if forn %}
                                    {{ forn.nome|truncatechars:25 }}
                                {% else %}
                                    -
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <input type="text" 
                               name="note" 
                               class="form-control form-control-sm" 
                               value="{{ item.ingresso.note|default:'' }}"
                               placeholder="Note...">
                    </td>
                    <td>
                        <button type="button" 
                                class="btn btn-sm btn-success btn-salva-riga" 
                                onclick="salvaRiga(this)">
                            <span class="material-icons">save</span>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center text-muted py-4">
                        Nessuno slot attivo per questa data
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="mt-3 text-muted">
        <span class="material-icons" style="font-size: 16px; vertical-align: middle;">info</span>
        Slot attivi: {{ slot_orari|length }} | Doppio click sui campi orario per inserire l'ora corrente
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Inserisce orario corrente su doppio click
function setCurrentTime(input) {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    input.value = `${hours}:${minutes}`;
    input.focus();
}

function salvaRiga(btn) {
    const row = btn.closest('tr');
    const slotId = row.dataset.slot;
    const data = row.dataset.data;
    
    const formData = new FormData();
    formData.append('slot_id', slotId);
    formData.append('data', data);
    formData.append('ingresso_1', row.querySelector('[name="ingresso_1"]').value);
    formData.append('uscita_1', row.querySelector('[name="uscita_1"]').value);
    formData.append('ingresso_2', row.querySelector('[name="ingresso_2"]').value);
    formData.append('uscita_2', row.querySelector('[name="uscita_2"]').value);
    formData.append('ingresso_extra', row.querySelector('[name="ingresso_extra"]').value);
    formData.append('uscita_extra', row.querySelector('[name="uscita_extra"]').value);
    formData.append('note', row.querySelector('[name="note"]').value);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    // Disabilita pulsante
    btn.disabled = true;
    const originalIcon = btn.querySelector('.material-icons').textContent;
    btn.querySelector('.material-icons').textContent = 'hourglass_empty';
    
    fetch("{% url 'merchandiser:salva_orario' %}", {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Feedback visivo
            btn.querySelector('.material-icons').textContent = 'check';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');
            
            setTimeout(() => {
                btn.querySelector('.material-icons').textContent = originalIcon;
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');
                btn.disabled = false;
            }, 1500);
        } else {
            alert('Errore: ' + (data.error || 'Salvataggio fallito'));
            btn.querySelector('.material-icons').textContent = originalIcon;
            btn.disabled = false;
        }
    })
    .catch(err => {
        console.error(err);
        alert('Errore durante il salvataggio');
        btn.querySelector('.material-icons').textContent = originalIcon;
        btn.disabled = false;
    });
}
</script>
{% endblock %}