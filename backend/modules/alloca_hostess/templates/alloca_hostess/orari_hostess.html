{% extends 'merchandiser/base_minimal.html' %}

{% block title %}Registrazione Orari Hostess{% endblock %}

{% block extra_css %}
<style>
    .date-selector {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .date-selector h5 {
        margin: 0;
        text-align: center;
    }
    
    .orari-table {
        font-size: 0.9em;
    }
    
    .orari-table th {
        background: #9c27b0;
        color: white;
        text-align: center;
        padding: 12px 8px;
        font-weight: 500;
    }
    
    .orari-table td {
        text-align: center;
        vertical-align: middle;
        padding: 8px 5px;
    }
    
    .orari-table input[type="time"] {
        width: 85px;
        padding: 4px 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.85em;
        cursor: pointer;
    }
    
    .orari-table input[type="time"]:focus {
        border-color: #9c27b0;
        outline: none;
    }
    
    .orari-table input[type="text"] {
        width: 100%;
        padding: 4px 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.85em;
    }
    
    .slot-number {
        font-weight: 600;
        color: #9c27b0;
    }
    
    .hostess-name {
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0">
        <span class="material-icons" style="vertical-align: middle;">access_time</span>
        Registrazione Orari Hostess
    </h4>
</div>

<!-- Data fissa: solo giorno corrente -->
<div class="date-selector">
    <h5>
        <span class="material-icons" style="vertical-align: middle; margin-right: 10px;">today</span>
        {{ data|date:"l d F Y"|upper }}
    </h5>
</div>

<!-- Tabella Orari -->
<div class="card">
    <div class="card-header">
        <span class="material-icons" style="vertical-align: middle;">schedule</span>
        Orari Giornalieri - {{ presenze_hostess|length }} Slot
    </div>
    <div class="card-body p-0">
        <table class="table table-bordered orari-table mb-0">
            <thead>
                <tr>
                    <th style="width: 60px;">Slot</th>
                    <th>Hostess</th>
                    <th>Agenzia</th>
                    <th>I.Mattino</th>
                    <th>U.Mattino</th>
                    <th>I.Pomeriggio</th>
                    <th>U.Pomeriggio</th>
                    <th>Fornitore</th>
                    <th style="width: 150px;">Note</th>
                    <th style="width: 60px;"></th>
                </tr>
            </thead>
            <tbody>
                {% for item in presenze_hostess %}
                <tr data-slot="{{ item.slot }}" data-data="{{ data|date:'Y-m-d' }}">
                    <td class="slot-number">{{ item.slot }}</td>
                    <td>
                        {% if item.presenza.hostess %}
                            <div class="hostess-name">{{ item.presenza.hostess.nominativo }}</div>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.presenza.agenzia %}
                            {{ item.presenza.agenzia.descrizione|truncatechars:20 }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <input type="time" 
                               class="orario-input" 
                               name="ingresso_mattino" 
                               value="{% if item.presenza.ingresso_mattino %}{{ item.presenza.ingresso_mattino|time:'H:i' }}{% endif %}"
                               ondblclick="setCurrentTime(this)">
                    </td>
                    <td>
                        <input type="time" 
                               class="orario-input" 
                               name="uscita_mattino" 
                               value="{% if item.presenza.uscita_mattino %}{{ item.presenza.uscita_mattino|time:'H:i' }}{% endif %}"
                               ondblclick="setCurrentTime(this)">
                    </td>
                    <td>
                        <input type="time" 
                               class="orario-input" 
                               name="ingresso_pomeriggio" 
                               value="{% if item.presenza.ingresso_pomeriggio %}{{ item.presenza.ingresso_pomeriggio|time:'H:i' }}{% endif %}"
                               ondblclick="setCurrentTime(this)">
                    </td>
                    <td>
                        <input type="time" 
                               class="orario-input" 
                               name="uscita_pomeriggio" 
                               value="{% if item.presenza.uscita_pomeriggio %}{{ item.presenza.uscita_pomeriggio|time:'H:i' }}{% endif %}"
                               ondblclick="setCurrentTime(this)">
                    </td>
                    <td>
                        {% if item.presenza.fornitore %}
                            {{ item.presenza.fornitore.nome|truncatechars:25 }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <input type="text" 
                               name="nota" 
                               class="form-control form-control-sm" 
                               value="{{ item.presenza.nota|default:'' }}"
                               placeholder="Note...">
                    </td>
                    <td>
                        <button type="button" 
                                class="btn btn-sm btn-outline-success btn-salva" 
                                onclick="salvaRiga(this)">
                            <span class="material-icons" style="font-size: 16px;">save</span>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center text-muted py-4">
                        Nessuna presenza per questa data
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="mt-3 text-muted">
    <span class="material-icons" style="font-size: 16px; vertical-align: middle;">info</span>
    Doppio click sui campi orario per inserire l'ora corrente
</div>
{% endblock %}

{% block extra_js %}
<script>
// Inserisce orario corrente su doppio click
function setCurrentTime(input) {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    input.value = `${hours}:${minutes}`;
    input.focus();
}

function salvaRiga(btn) {
    const row = btn.closest('tr');
    const slot = row.dataset.slot;
    const giorno = row.dataset.data;
    
    const formData = new FormData();
    formData.append('slot', slot);
    formData.append('giorno', giorno);
    formData.append('ingresso_mattino', row.querySelector('[name="ingresso_mattino"]').value);
    formData.append('uscita_mattino', row.querySelector('[name="uscita_mattino"]').value);
    formData.append('ingresso_pomeriggio', row.querySelector('[name="ingresso_pomeriggio"]').value);
    formData.append('uscita_pomeriggio', row.querySelector('[name="uscita_pomeriggio"]').value);
    formData.append('nota', row.querySelector('[name="nota"]').value);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    fetch("{% url 'alloca_hostess:salva_orario_hostess' %}", {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            btn.innerHTML = '<span class="material-icons" style="font-size: 16px;">check</span>';
            btn.classList.remove('btn-outline-success');
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.innerHTML = '<span class="material-icons" style="font-size: 16px;">save</span>';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-success');
                btn.disabled = false;
            }, 1500);
        } else {
            alert(data.error || 'Errore durante il salvataggio');
            btn.innerHTML = '<span class="material-icons" style="font-size: 16px;">error</span>';
            btn.disabled = false;
        }
    })
    .catch(err => {
        console.error(err);
        alert('Errore durante il salvataggio');
        btn.innerHTML = '<span class="material-icons" style="font-size: 16px;">error</span>';
        btn.disabled = false;
    });
}
</script>
{% endblock %}